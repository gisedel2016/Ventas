```html
    <!-- ID de dispositivo -->
    <div class="mb-4 text-center text-xs text-gray-500">
        ID de dispositivo: <span id="dispositivo-id">generando...</span>
    </div>
    
    <!-- Encabezado -->
    <header class="text-center mb-6">
        <h1 class="text-3xl font-bold text-indigo-800">Mi Inventario</h1>
        <p class="text-gray-600" id="fecha-actual"></p>
    </header>

    <!-- Navegación -->
    <div class="bg-white rounded-lg shadow-md mb-6 overflow-hidden">
        <div class="flex border-b">
            <button id="btn-inventario" class="flex-1 py-3 font-medium text-indigo-800 border-b-2 border-indigo-600">
                Inventario
            </button>
            <button id="btn-ventas" class="flex-1 py-3 font-medium text-gray-600">
                Ventas del Día
            </button>
        </div>
    </div>

    <!-- Vista de Inventario -->
    <div id="vista-inventario" class="slide-in">
        <!-- Buscador -->
        <div class="relative mb-4">
            <input type="text" id="buscar-producto" placeholder="Buscar producto..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-2.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </div>

        <!-- Lista de productos -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-semibold text-gray-800">Productos</h2>
                <button id="btn-mostrar-formulario" class="bg-indigo-600 text-white px-3 py-1 rounded-lg hover:bg-indigo-700 transition flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Nuevo
                </button>
            </div>
            <div id="lista-productos" class="divide-y max-h-96 overflow-y-auto">
                <!-- Los productos se cargarán dinámicamente aquí -->
                <div class="p-4 text-center text-gray-500">Cargando productos...</div>
            </div>
        </div>

        <!-- Formulario para agregar producto (oculto por defecto) -->
        <div id="form-container" class="bg-white rounded-lg shadow-md p-4 mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Agregar Producto</h2>
                <button id="btn-cerrar-formulario" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="form-producto" class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-1">Nombre del Producto</label>
                    <input type="text" id="nombre-producto" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">Precio (€)</label>
                    <input type="number" id="precio-producto" step="0.01" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition">
                    Agregar al Inventario
                </button>
            </form>
        </div>
    </div>

    <!-- Vista de Ventas del Día -->
    <div id="vista-ventas" class="hidden slide-in">
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Resumen de Ventas</h2>
                <button id="btn-reiniciar" class="px-3 py-1 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600 transition">
                    Reiniciar Día
                </button>
            </div>
            <div class="bg-indigo-50 p-4 rounded-lg mb-4">
                <div class="flex justify-between mb-2">
                    <span class="text-gray-700">Total Vendido:</span>
                    <span id="total-vendido" class="font-bold text-indigo-800">€0.00</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-700">Productos Vendidos:</span>
                    <span id="productos-vendidos" class="font-bold text-indigo-800">0</span>
                </div>
            </div>
        </div>

        <!-- Lista de ventas -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <h2 class="text-xl font-semibold text-gray-800 p-4 border-b">Detalle de Ventas</h2>
            <div id="lista-ventas" class="divide-y max-h-96 overflow-y-auto">
                <!-- Las ventas se cargarán dinámicamente aquí -->
                <div class="p-4 text-center text-gray-500">No hay ventas registradas hoy</div>
            </div>
        </div>
    </div>

    <!-- Modal de Edición -->
    <div id="modal-edicion" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-5/6 max-w-md fade-in">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Editar Producto</h3>
            <form id="form-edicion" class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-1">Nombre del Producto</label>
                    <input type="text" id="edit-nombre" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">Precio (€)</label>
                    <input type="number" id="edit-precio" step="0.01" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="flex space-x-2">
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition">
                        Guardar
                    </button>
                    <button type="button" id="btn-eliminar" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition">
                        Eliminar
                    </button>
                </div>
                <button type="button" id="btn-cancelar" class="w-full border border-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-100 transition">
                    Cancelar
                </button>
            </form>
        </div>
    </div>

    <!-- Modal de Venta -->
    <div id="modal-venta" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-5/6 max-w-md fade-in">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Vender Producto</h3>
            <div id="producto-venta-info" class="mb-4 p-3 bg-gray-50 rounded-lg">
                <h4 class="font-medium text-gray-800" id="venta-nombre-producto">Nombre del producto</h4>
                <p class="text-gray-600" id="venta-precio-producto">€0.00</p>
            </div>
            <form id="form-venta" class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-1">Cantidad</label>
                    <input type="number" id="venta-cantidad" min="1" value="1" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="bg-indigo-50 p-3 rounded-lg mb-2">
                    <div class="flex justify-between">
                        <span class="text-gray-700">Total:</span>
                        <span id="venta-total" class="font-bold text-indigo-800">€0.00</span>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition pulse-animation">
                        Confirmar Venta
                    </button>
                    <button type="button" id="btn-cancelar-venta" class="flex-1 border border-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-100 transition">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmación -->
    <div id="modal-confirmacion" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-5/6 max-w-md fade-in">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Confirmar Acción</h3>
            <p id="mensaje-confirmacion" class="text-gray-600 mb-6">¿Estás seguro de que deseas realizar esta acción?</p>
            <div class="flex space-x-2">
                <button id="btn-confirmar" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition">
                    Confirmar
                </button>
                <button id="btn-cancelar-confirmacion" class="flex-1 border border-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-100 transition">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Notificación -->
    <div id="notificacion" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg bg-green-500 text-white text-center min-w-[200px] z-50 hidden">
        Mensaje de notificación
    </div>
    
    <!-- Botón de sincronización manual -->
    <div class="fixed bottom-4 right-4">
        <button id="btn-sincronizar" class="bg-indigo-600 text-white p-3 rounded-full shadow-lg hover:bg-indigo-700 transition">
            <svg xmlns="http://www.w3.org/2000/svg" id="icono-sincronizar" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        </button>
    </div>
</div>

<script>
    // Referencias a elementos del DOM
    const estadoSincronizacion = document.getElementById('estado-sincronizacion');
    const dispositivoIdEl = document.getElementById('dispositivo-id');
    const fechaActualEl = document.getElementById('fecha-actual');
    const btnInventario = document.getElementById('btn-inventario');
    const btnVentas = document.getElementById('btn-ventas');
    const vistaInventario = document.getElementById('vista-inventario');
    const vistaVentas = document.getElementById('vista-ventas');
    const btnMostrarFormulario = document.getElementById('btn-mostrar-formulario');
    const btnCerrarFormulario = document.getElementById('btn-cerrar-formulario');
    const formContainer = document.getElementById('form-container');
    const formProducto = document.getElementById('form-producto');
    const nombreProductoInput = document.getElementById('nombre-producto');
    const precioProductoInput = document.getElementById('precio-producto');
    const listaProductos = document.getElementById('lista-productos');
    const buscarProductoInput = document.getElementById('buscar-producto');
    const listaVentas = document.getElementById('lista-ventas');
    const totalVendidoEl = document.getElementById('total-vendido');
    const productosVendidosEl = document.getElementById('productos-vendidos');
    const btnReiniciar = document.getElementById('btn-reiniciar');
    const btnSincronizar = document.getElementById('btn-sincronizar');
    const iconoSincronizar = document.getElementById('icono-sincronizar');
    
    // Modal de edición
    const modalEdicion = document.getElementById('modal-edicion');
    const formEdicion = document.getElementById('form-edicion');
    const editNombreInput = document.getElementById('edit-nombre');
    const editPrecioInput = document.getElementById('edit-precio');
    const btnEliminar = document.getElementById('btn-eliminar');
    const btnCancelar = document.getElementById('btn-cancelar');
    
    // Modal de venta
    const modalVenta = document.getElementById('modal-venta');
    const formVenta = document.getElementById('form-venta');
    const ventaNombreProducto = document.getElementById('venta-nombre-producto');
    const ventaPrecioProducto = document.getElementById('venta-precio-producto');
    const ventaCantidadInput = document.getElementById('venta-cantidad');
    const ventaTotalEl = document.getElementById('venta-total');
    const btnCancelarVenta = document.getElementById('btn-cancelar-venta');
    
    // Modal de confirmación
    const modalConfirmacion = document.getElementById('modal-confirmacion');
    const mensajeConfirmacion = document.getElementById('mensaje-confirmacion');
    const btnConfirmar = document.getElementById('btn-confirmar');
    const btnCancelarConfirmacion = document.getElementById('btn-cancelar-confirmacion');
    
    // Notificación
    const notificacionEl = document.getElementById('notificacion');
    
    // Variables globales
    let productoEditandoId = null;
    let productoAEliminarId = null;
    let productoVendiendoId = null;
    let accionConfirmacion = null;
    let productos = {};
    let ventas = {};
    let fechaActual = obtenerFechaActual();
    let dispositivoId = '';
    let ultimaSincronizacion = 0;
    let sincronizacionEnProgreso = false;
    let ultimoEventoSync = 0;
    
    // Constantes para sincronización
    const SYNC_INTERVAL = 300; // 300ms para una sincronización más rápida
    const FORCE_SYNC_INTERVAL = 3000; // Forzar sincronización cada 3 segundos
    const PRODUCTOS_KEY = 'inventario_productos';
    const VENTAS_KEY_PREFIX = 'inventario_ventas_';
    const SYNC_TIMESTAMP_KEY = 'inventario_sync_timestamp';
    const SYNC_TRIGGER_KEY = 'inventario_sync_trigger';
    const SYNC_DEVICE_KEY = 'inventario_sync_device';
    
    // Generar ID único para este dispositivo
    function generarDispositivoId() {
        // Usar localStorage en lugar de sessionStorage para mantener el ID entre sesiones
        let id = localStorage.getItem('dispositivoId');
        if (!id) {
            id = 'disp_' + Math.random().toString(36).substring(2, 10) + '_' + Date.now();
            localStorage.setItem('dispositivoId', id);
        }
        return id;
    }
    
    // Mostrar fecha actual
    fechaActualEl.textContent = formatearFecha(new Date());
    
    // Cambiar entre vistas
    btnInventario.addEventListener('click', () => {
        btnInventario.classList.add('border-b-2', 'border-indigo-600', 'text-indigo-800');
        btnInventario.classList.remove('text-gray-600');
        btnVentas.classList.remove('border-b-2', 'border-indigo-600', 'text-indigo-800');
        btnVentas.classList.add('text-gray-600');
        vistaInventario.classList.remove('hidden');
        vistaVentas.classList.add('hidden');
    });
    
    btnVentas.addEventListener('click', () => {
        btnVentas.classList.add('border-b-2', 'border-indigo-600', 'text-indigo-800');
        btnVentas.classList.remove('text-gray-600');
        btnInventario.classList.remove('border-b-2', 'border-indigo-600', 'text-indigo-800');
        btnInventario.classList.add('text-gray-600');
        vistaVentas.classList.remove('hidden');
        vistaInventario.classList.add('hidden');
        renderizarVentas();
        actualizarResumenVentas();
    });
    
    // Mostrar/ocultar formulario de agregar producto
    btnMostrarFormulario.addEventListener('click', () => {
        formContainer.classList.remove('hidden');
        nombreProductoInput.focus();
    });
    
    btnCerrarFormulario.addEventListener('click', () => {
        formContainer.classList.add('hidden');
    });
    
    // Agregar producto
    formProducto.addEventListener('submit', (e) => {
        e.preventDefault();
        const nombre = nombreProductoInput.value.trim();
        const precio = parseFloat(precioProductoInput.value);
        
        if (nombre && !isNaN(precio) && precio > 0) {
            const id = 'p_' + Date.now() + '_' + dispositivoId;
            const nuevoProducto = {
                id,
                nombre,
                precio,
                timestamp: Date.now(),
                createdBy: dispositivoId
            };
            
            productos[id] = nuevoProducto;
            guardarProductos();
            
            nombreProductoInput.value = '';
            precioProductoInput.value = '';
            formContainer.classList.add('hidden');
            renderizarProductos();
            mostrarNotificacion('Producto agregado correctamente');
            
            // Sincronizar con otros dispositivos
            sincronizarDatos(true);
        }
    });
    
    // Buscar productos
    buscarProductoInput.addEventListener('input', () => {
        const busqueda = buscarProductoInput.value.toLowerCase();
        renderizarProductos(busqueda);
    });
    
    // Reiniciar ventas del día
    btnReiniciar.addEventListener('click', () => {
        mostrarConfirmacion('¿Estás seguro de que deseas reiniciar las ventas del día?', 'reiniciarVentas');
    });
    
    // Sincronizar manualmente
    btnSincronizar.addEventListener('click', () => {
        if (!sincronizacionEnProgreso) {
            iconoSincronizar.classList.add('sync-spin');
            sincronizarDatos(true);
        }
    });
    
    // Funciones para el modal de edición
    function abrirModalEdicion(id) {
        productoEditandoId = id;
        const producto = productos[id];
        
        editNombreInput.value = producto.nombre;
        editPrecioInput.value = producto.precio;
        modalEdicion.classList.remove('hidden');
    }
    
    function cerrarModalEdicion() {
        modalEdicion.classList.add('hidden');
        productoEditandoId = null;
    }
    
    formEdicion.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!productoEditandoId) return;
        
        const nombre = editNombreInput.value.trim();
        const precio = parseFloat(editPrecioInput.value);
        
        if (nombre && !isNaN(precio) && precio > 0) {
            productos[productoEditandoId].nombre = nombre;
            productos[productoEditandoId].precio = precio;
            productos[productoEditandoId].lastUpdated = Date.now();
            productos[productoEditandoId].updatedBy = dispositivoId;
            
            guardarProductos();
            cerrarModalEdicion();
            renderizarProductos();
            mostrarNotificacion('Producto actualizado correctamente');
            
            // Sincronizar con otros dispositivos
            sincronizarDatos(true);
        }
    });
    
    btnEliminar.addEventListener('click', () => {
        // Guardar el ID del producto a eliminar antes de cerrar el modal
        productoAEliminarId = productoEditandoId;
        cerrarModalEdicion();
        mostrarConfirmacion('¿Estás seguro de que deseas eliminar este producto?', 'eliminarProducto');
    });
    
    btnCancelar.addEventListener('click', cerrarModalEdicion);
    
    // Funciones para el modal de venta
    function abrirModalVenta(id) {
        productoVendiendoId = id;
        const producto = productos[id];
        
        ventaNombreProducto.textContent = producto.nombre;
        ventaPrecioProducto.textContent = `€${producto.precio.toFixed(2)}`;
        ventaCantidadInput.value = 1;
        actualizarTotalVenta();
        
        modalVenta.classList.remove('hidden');
    }
    
    function cerrarModalVenta() {
        modalVenta.classList.add('hidden');
        productoVendiendoId = null;
    }
    
    function actualizarTotalVenta() {
        if (!productoVendiendoId) return;
        
        const producto = productos[productoVendiendoId];
        const cantidad = parseInt(ventaCantidadInput.value) || 1;
        const total = producto.precio * cantidad;
        
        ventaTotalEl.textContent = `€${total.toFixed(2)}`;
    }
    
    ventaCantidadInput.addEventListener('input', actualizarTotalVenta);
    
    formVenta.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!productoVendiendoId) return;
        
        const cantidad = parseInt(ventaCantidadInput.value) || 1;
        if (cantidad < 1) {
            mostrarNotificacion('La cantidad debe ser al menos 1', true);
            return;
        }
        
        venderProducto(productoVendiendoId, cantidad);
        cerrarModalVenta();
    });
    
    btnCancelarVenta.addEventListener('click', cerrarModalVenta);
    
    // Funciones para el modal de confirmación
    function mostrarConfirmacion(mensaje, accion) {
        mensajeConfirmacion.textContent = mensaje;
        accionConfirmacion = accion;
        modalConfirmacion.classList.remove('hidden');
    }
    
    function cerrarModalConfirmacion() {
        modalConfirmacion.classList.add('hidden');
        accionConfirmacion = null;
    }
    
    btnConfirmar.addEventListener('click', () => {
        if (accionConfirmacion === 'eliminarProducto') {
            eliminarProducto();
        } else if (accionConfirmacion === 'reiniciarVentas') {
            reiniciarVentas();
        }
        cerrarModalConfirmacion();
    });
    
    btnCancelarConfirmacion.addEventListener('click', cerrarModalConfirmacion);
    
    function eliminarProducto() {
        // Usar el ID guardado para eliminar el producto
        if (productoAEliminarId && productos[productoAEliminarId]) {
            delete productos[productoAEliminarId];
            
            guardarProductos();
            renderizarProductos();
            mostrarNotificacion('Producto eliminado correctamente');
            
            // Sincronizar con otros dispositivos
            sincronizarDatos(true);
            
            // Limpiar el ID después de eliminar
            productoAEliminarId = null;
        }
    }
    
    function reiniciarVentas() {
        ventas = {};
        guardarVentas();
        renderizarVentas();
        actualizarResumenVentas();
        mostrarNotificacion('Ventas del día reiniciadas');
        
        // Sincronizar con otros dispositivos
        sincronizarDatos(true);
    }
    
    // Vender producto
    function venderProducto(id, cantidad = 1) {
        const producto = productos[id];
        if (!producto) return;
        
        const ventaId = 'v_' + Date.now() + '_' + dispositivoId;
        const nuevaVenta = {
            id: ventaId,
            productoId: id,
            nombre: producto.nombre,
            precio: producto.precio,
            cantidad: cantidad,
            total: producto.precio * cantidad,
            timestamp: Date.now(),
            createdBy: dispositivoId
        };
        
        ventas[ventaId] = nuevaVenta;
        guardarVentas();
        
        mostrarNotificacion(`Vendido: ${cantidad} x ${producto.nombre}`);
        
        // Si estamos en la vista de ventas, actualizar
        if (!vistaVentas.classList.contains('hidden')) {
            renderizarVentas();
            actualizarResumenVentas();
        }
        
        // Sincronizar con otros dispositivos
        sincronizarDatos(true);
    }
    
    // Renderizar productos
    function renderizarProductos(filtro = '') {
        // Obtener productos activos
        const productosActivos = Object.values(productos);
        
        if (productosActivos.length === 0) {
            listaProductos.innerHTML = '<div class="p-4 text-center text-gray-500">No hay productos en el inventario</div>';
            return;
        }
        
        // Ordenar productos alfabéticamente por nombre
        productosActivos.sort((a, b) => a.nombre.localeCompare(b.nombre));
        
        listaProductos.innerHTML = '';
        
        productosActivos.forEach((producto) => {
            if (filtro && !producto.nombre.toLowerCase().includes(filtro)) {
                return;
            }
            
            const productoEl = document.createElement('div');
            productoEl.className = 'p-4 hover:bg-gray-50';
            productoEl.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-medium text-gray-800">${producto.nombre}</h3>
                        <p class="text-gray-600">€${producto.precio.toFixed(2)}</p>
                    </div>
                    <button class="btn-vender bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition pulse-animation">
                        Vender
                    </button>
                </div>
            `;
            
            // Agregar evento para vender
            const btnVender = productoEl.querySelector('.btn-vender');
            btnVender.addEventListener('click', (e) => {
                e.stopPropagation();
                abrirModalVenta(producto.id);
            });
            
            // Agregar evento para editar (al hacer clic en el producto, no en el botón)
            productoEl.addEventListener('click', (e) => {
                if (!e.target.classList.contains('btn-vender') && !e.target.closest('.btn-vender')) {
                    abrirModalEdicion(producto.id);
                }
            });
            
            listaProductos.appendChild(productoEl);
        });
    }
    
    // Renderizar ventas
    function renderizarVentas() {
        if (!ventas || Object.keys(ventas).length === 0) {
            listaVentas.innerHTML = '<div class="p-4 text-center text-gray-500">No hay ventas registradas hoy</div>';
            return;
        }
        
        listaVentas.innerHTML = '';
        
        Object.values(ventas)
            .sort((a, b) => b.timestamp - a.timestamp)
            .forEach((venta) => {
                const ventaEl = document.createElement('div');
                ventaEl.className = 'p-4';
                ventaEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-medium text-gray-800">
                                ${venta.nombre}
                                ${venta.cantidad > 1 ? `<span class="text-gray-600">(x${venta.cantidad})</span>` : ''}
                            </h3>
                            <p class="text-xs text-gray-500">${formatearHora(new Date(venta.timestamp))}</p>
                        </div>
                        <span class="font-medium text-green-600">€${(venta.total || venta.precio).toFixed(2)}</span>
                    </div>
                `;
                listaVentas.appendChild(ventaEl);
            });
    }
    
    // Actualizar resumen de ventas
    function actualizarResumenVentas() {
        if (!ventas || Object.keys(ventas).length === 0) {
            totalVendidoEl.textContent = '€0.00';
            productosVendidosEl.textContent = '0';
            return;
        }
        
        const total = Object.values(ventas).reduce((sum, venta) => {
            // Compatibilidad con ventas antiguas que no tienen total o cantidad
            const ventaTotal = venta.total || (venta.precio * (venta.cantidad || 1));
            return sum + ventaTotal;
        }, 0);
        
        // Contar unidades totales vendidas (sumando cantidades)
        const unidadesVendidas = Object.values(ventas).reduce((sum, venta) => {
            return sum + (venta.cantidad || 1);
        }, 0);
        
        totalVendidoEl.textContent = `€${total.toFixed(2)}`;
        productosVendidosEl.textContent = unidadesVendidas;
    }
    
    // Mostrar notificación
    function mostrarNotificacion(mensaje, esError = false) {
        notificacionEl.textContent = mensaje;
        notificacionEl.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg ${
            esError ? 'bg-red-500' : 'bg-green-500'
        } text-white text-center min-w-[200px] z-50`;
        
        notificacionEl.classList.remove('hidden');
        
        setTimeout(() => {
            notificacionEl.classList.add('opacity-0', 'transition-opacity');
            setTimeout(() => {
                notificacionEl.classList.add('hidden');
                notificacionEl.classList.remove('opacity-0', 'transition-opacity');
            }, 300);
        }, 2000);
    }
    
    // Funciones de almacenamiento local
    function cargarProductos() {
        try {
            const productosGuardados = localStorage.getItem(PRODUCTOS_KEY);
            if (productosGuardados) {
                productos = JSON.parse(productosGuardados);
            } else {
                // Productos de ejemplo
                productos = {
                    "p_1": { id: "p_1", nombre: "Camiseta", precio: 19.99, timestamp: Date.now() },
                    "p_2": { id: "p_2", nombre: "Pantalón", precio: 29.99, timestamp: Date.now() },
                    "p_3": { id: "p_3", nombre: "Zapatos", precio: 49.99, timestamp: Date.now() },
                    "p_4": { id: "p_4", nombre: "Gorra", precio: 9.99, timestamp: Date.now() }
                };
                guardarProductos();
            }
        } catch (error) {
            console.error("Error al cargar productos:", error);
            productos = {};
        }
    }
    
    function cargarVentas() {
        try {
            const ventasGuardadas = localStorage.getItem(VENTAS_KEY_PREFIX + fechaActual);
            if (ventasGuardadas) {
                ventas = JSON.parse(ventasGuardadas);
            } else {
                ventas = {};
            }
        } catch (error) {
            console.error("Error al cargar ventas:", error);
            ventas = {};
        }
    }
    
    function guardarProductos() {
        try {
            localStorage.setItem(PRODUCTOS_KEY, JSON.stringify(productos));
            // Actualizar timestamp de sincronización
            const ahora = Date.now();
            localStorage.setItem(SYNC_TIMESTAMP_KEY, ahora.toString());
            // Disparar evento de sincronización con ID de dispositivo
            localStorage.setItem(SYNC_TRIGGER_KEY, ahora.toString());
            localStorage.setItem(SYNC_DEVICE_KEY, dispositivoId);
        } catch (error) {
            console.error("Error al guardar productos:", error);
            mostrarNotificacion("Error al guardar productos", true);
        }
    }
    
    function guardarVentas() {
        try {
            localStorage.setItem(VENTAS_KEY_PREFIX + fechaActual, JSON.stringify(ventas));
            // Actualizar timestamp de sincronización
            const ahora = Date.now();
            localStorage.setItem(SYNC_TIMESTAMP_KEY, ahora.toString());
            // Disparar evento de sincronización con ID de dispositivo
            localStorage.setItem(SYNC_TRIGGER_KEY, ahora.toString());
            localStorage.setItem(SYNC_DEVICE_KEY, dispositivoId);
        } catch (error) {
            console.error("Error al guardar ventas:", error);
            mostrarNotificacion("Error al guardar ventas", true);
        }
    }
    
    // Funciones de sincronización
    function sincronizarDatos(forzar = false) {
        if (sincronizacionEnProgreso && !forzar) return;
        
        sincronizacionEnProgreso = true;
        actualizarEstadoSincronizacion('sincronizando');
        
        try {
            // Verificar si hay cambios en localStorage
            verificarCambiosEnLocalStorage();
            
            // Actualizar timestamp de última sincronización
            ultimaSincronizacion = Date.now();
            
            // Forzar actualización de localStorage para otros dispositivos
            const ahora = Date.now();
            localStorage.setItem(SYNC_TRIGGER_KEY, ahora.toString());
            localStorage.setItem(SYNC_DEVICE_KEY, dispositivoId);
            
            setTimeout(() => {
                actualizarEstadoSincronizacion('sincronizado');
                sincronizacionEnProgreso = false;
                iconoSincronizar.classList.remove('sync-spin');
                
                // Después de un tiempo, cambiar a "en tiempo real"
                setTimeout(() => {
                    actualizarEstadoSincronizacion('tiempo-real');
                }, 1000);
            }, 500);
        } catch (error) {
            console.error("Error en sincronización:", error);
            actualizarEstadoSincronizacion('error');
            sincronizacionEnProgreso = false;
            iconoSincronizar.classList.remove('sync-spin');
            mostrarNotificacion("Error de sincronización", true);
        }
    }
    
    function verificarCambiosEnLocalStorage() {
        try {
            // Cargar productos desde localStorage
            const productosGuardados = localStorage.getItem(PRODUCTOS_KEY);
            if (productosGuardados) {
                const productosObj = JSON.parse(productosGuardados);
                // Comparar con los productos locales
                if (JSON.stringify(productosObj) !== JSON.stringify(productos)) {
                    productos = productosObj;
                    renderizarProductos(buscarProductoInput.value.toLowerCase());
                }
            }
            
            // Cargar ventas desde localStorage
            const ventasGuardadas = localStorage.getItem(VENTAS_KEY_PREFIX + fechaActual);
            if (ventasGuardadas) {
                const ventasObj = JSON.parse(ventasGuardadas);
                // Comparar con las ventas locales
                if (JSON.stringify(ventasObj) !== JSON.stringify(ventas)) {
                    ventas = ventasObj;
                    if (!vistaVentas.classList.contains('hidden')) {
                        renderizarVentas();
                        actualizarResumenVentas();
                    }
                }
            }
        } catch (error) {
            console.error("Error al verificar cambios en localStorage:", error);
            throw error;
        }
    }
    
    function actualizarEstadoSincronizacion(estado) {
        switch (estado) {
            case 'sincronizando':
                estadoSincronizacion.innerHTML = '<span class="inline-block w-3 h-3 rounded-full bg-yellow-500 mr-1"></span><span>Sincronizando...</span>';
                break;
            case 'sincronizado':
                estadoSincronizacion.innerHTML = '<span class="inline-block w-3 h-3 rounded-full bg-green-500 mr-1"></span><span>Sincronizado</span>';
                break;
            case 'tiempo-real':
                estadoSincronizacion.innerHTML = '<span class="inline-block w-3 h-3 rounded-full bg-blue-500 mr-1"></span><span>Sincronización en tiempo real</span>';
                break;
            case 'error':
                estadoSincronizacion.innerHTML = '<span class="inline-block w-3 h-3 rounded-full bg-red-500 mr-1"></span><span>Error de sincronización</span>';
                break;
            default:
                estadoSincronizacion.innerHTML = '<span class="inline-block w-3 h-3 rounded-full bg-gray-400 mr-1"></span><span>Sincronización local</span>';
        }
    }
    
    // Comprobar cambios periódicamente
    function iniciarComprobacionCambios() {
        setInterval(() => {
            if (!sincronizacionEnProgreso) {
                verificarCambiosEnLocalStorage();
            }
        }, SYNC_INTERVAL);
    }
    
    // Funciones de utilidad
    function obtenerFechaActual() {
        const fecha = new Date();
        return `${fecha.getFullYear()}-${(fecha.getMonth() + 1).toString().padStart(2, '0')}-${fecha.getDate().toString().padStart(2, '0')}`;
    }
    
    function formatearFecha(fecha) {
        return fecha.toLocaleDateString('es-ES', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }
    
    function formatearHora(fecha) {
        return fecha.toLocaleTimeString('es-ES', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    // Inicializar la aplicación
    function inicializar() {
        // Generar ID de dispositivo
        dispositivoId = generarDispositivoId();
        dispositivoIdEl.textContent = dispositivoId;
        
        // Comprobar si es un nuevo día
        const nuevaFecha = obtenerFechaActual();
        if (fechaActual !== nuevaFecha) {
            fechaActual = nuevaFecha;
            fechaActualEl.textContent = formatearFecha(new Date());
        }
        
        // Cargar datos
        cargarProductos();
        cargarVentas();
        
        // Renderizar la interfaz
        renderizarProductos();
        
        // Sincronizar al inicio
        sincronizarDatos(true);
        
        // Iniciar comprobación de cambios
        iniciarComprobacionCambios();
        
        // Forzar sincronización inicial para todos los dispositivos
        const ahora = Date.now();
        localStorage.setItem(SYNC_TRIGGER_KEY, ahora.toString());
        localStorage.setItem(SYNC_DEVICE_KEY, dispositivoId);
    }
    
    // Iniciar la aplicación
    inicializar();
    
    // Evento de almacenamiento para detectar cambios en otros tabs/ventanas
    window.addEventListener('storage', (event) => {
        // Evitar procesar eventos demasiado rápido o duplicados
        if (Date.now() - ultimoEventoSync < 100) return;
        ultimoEventoSync = Date.now();
        
        if (event.key === PRODUCTOS_KEY || 
            event.key === VENTAS_KEY_PREFIX + fechaActual ||
            event.key === SYNC_TRIGGER_KEY) {
            
            // No procesar eventos generados por este mismo dispositivo
            if (event.key === SYNC_TRIGGER_KEY) {
                const deviceId = localStorage.getItem(SYNC_DEVICE_KEY);
                if (deviceId === dispositivoId) return;
            }
            
            // Mostrar indicador de sincronización
            actualizarEstadoSincronizacion('sincronizando');
            
            // Verificar cambios
            verificarCambiosEnLocalStorage();
            
            // Actualizar estado
            setTimeout(() => {
                actualizarEstadoSincronizacion('sincronizado');
                setTimeout(() => {
                    actualizarEstadoSincronizacion('tiempo-real');
                }, 1000);
            }, 500);
        }
    });
    
    // Evento para cuando la ventana se vuelve visible
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            // Sincronizar inmediatamente cuando la ventana se vuelve visible
            sincronizarDatos(true);
        }
    });
    
    // Evento para cuando la ventana se cierra
    window.addEventListener('beforeunload', () => {
        // Intentar sincronizar antes de cerrar
        const ahora = Date.now();
        localStorage.setItem(SYNC_TRIGGER_KEY, ahora.toString());
        localStorage.setItem(SYNC_DEVICE_KEY, dispositivoId);
    });
    
    // Sincronización forzada cada cierto tiempo para dispositivos móviles
    setInterval(() => {
        sincronizarDatos(true);
    }, FORCE_SYNC_INTERVAL);
    
    // Verificar conexión y sincronizar cuando esté online
    window.addEventListener('online', () => {
        mostrarNotificacion('Conexión restablecida');
        sincronizarDatos(true);
    });
    
    window.addEventListener('offline', () => {
        mostrarNotificacion('Sin conexión - modo local', true);
        actualizarEstadoSincronizacion('error');
    });
    
    // Forzar sincronización al cargar la página
    window.addEventListener('load', () => {
        setTimeout(() => {
            sincronizarDatos(true);
        }, 1000);
    });
</script>
